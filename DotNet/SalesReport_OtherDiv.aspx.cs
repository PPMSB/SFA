using GLOBAL_FUNCTION;
using GLOBAL_VAR;
using Microsoft.Dynamics.BusinessConnectorNet;
using MySql.Data.MySqlClient;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Web.UI;
using System.Web.UI.HtmlControls;

namespace DotNet
{
    public partial class SalesReport_OtherDiv : System.Web.UI.Page
    {
        public static bool Flag;
        protected void Page_Load(object sender, EventArgs e)
        {
            Function_Method.isPBM = true;
            Function_Method.isVPPPCampaign = false;
            AddPrivateLog("Sales Report Other Div");

            lblAutoGenerated.Text = SalesReport_Get_Budget.autoGen;

            Execute("PPM", SalesReport_Get_Budget.now);
            Execute("PBM", SalesReport_Get_Budget.now);
        }

        private void Execute(string company, DateTime now)
        {
            GLOBAL.switch_Company = company; GLOBAL.user_id = GLOBAL.AdminID;
            Axapta DynAx = Function_Method.GlobalAxapta();

            AddPrivateLog(company + " YTD Sales Report");
            string temp_email = ""; int count = 0;
            try
            {
                List<string> email = new List<string>();

                Regex regex = new Regex(@"^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$",
                    RegexOptions.CultureInvariant | RegexOptions.Singleline);

                var getEmplDetails = SalesReport_Get_Budget.getEmpDetailsOtherDiv(DynAx);

                for (int i = 0; i < getEmplDetails.Item5; i++)
                {
                    hdsalesman.Value = getEmplDetails.Item1[i];

                    if (temp_email != getEmplDetails.Item6[i] && !string.IsNullOrEmpty(getEmplDetails.Item6[i]))// check salesman second account/check email is empty or not
                    {
                        if (regex.IsMatch(getEmplDetails.Item6[i]) && !email.Contains(getEmplDetails.Item6[i]))// validate email/check for existed email
                        {
                            email.Add(getEmplDetails.Item6[i]);//store first email
                            DailySalesReport(DynAx, getEmplDetails.Item4[0], now);
                            temp_email = getEmplDetails.Item6[i];//set it to temp for second account checking purposes

                            string getHODemail = SalesReport_Get_Budget.getEmail(DynAx, getEmplDetails.Item7[i]);

                            GetEmailInfo(getEmplDetails.Item6[i], getHODemail, "", "", "");

                            InsertSQL(company + " YTD - " + getEmplDetails.Item6[i]);

                            AddPrivateLog("- " + company + " YTD - " + getEmplDetails.Item6[i]);

                            count++;
                        }
                    }
                }
                getEmplDetails = null;

                AddPrivateLog(" " + count.ToString() + " " + company + " YTD Sales Report email sent completed.");
            }
            catch (Exception ex)
            {
                AddPrivateLog("> Error: " + ex.Message);
                throw;
            }
            finally
            {
                DynAx.Dispose();
            }
        }

        protected void DailySalesReport(Axapta DynAx, string SalesmanID, DateTime now)
        {
            var currentDate = new DateTime(now.Year, now.Month, now.Day).ToString("dd/MM/yyyy");
            var firstDayOfYear = new DateTime(now.Year, 1, 1).ToString("dd/MM/yyyy");
            var firstDayOfMonth = new DateTime(now.Year, now.Month, 1).ToString("dd/MM/yyyy");
            var lastDayOfMonth = new DateTime(now.Year, now.Month, DateTime.DaysInMonth(now.Year, now.Month)).ToString("dd/MM/yyyy");
            lblDescription.Text = "Sales Report for " + hdsalesman.Value + " On ";
            lblDate.Text = DateTime.Now.ToString();

            try
            {
                var getEmplDetails = SalesReport_Get_Budget.getEmpDetailsOtherDiv(DynAx, SalesmanID);
                //var getEmail = SalesReport_Get_Budget.getEmpDetails2(DynAx, getEmplDetails.Item6);

                List<double> totalSalesOrder = new List<double>();
                double sumSalesOrder = 0;
                List<double> totalInvoicedSales = new List<double>();
                List<double> totalInvoiceSalesYTD = new List<double>();
                List<int> totalBudget = new List<int>();
                List<int> totalBudgetYTD = new List<int>();
                double yearlyBudget = 0;
                string monthlyPeriodName = SalesReport_Get_Budget.getStartDateToDate(DynAx, lastDayOfMonth);

                for (int i = 0; i < getEmplDetails.Item4; i++)//count salesman email
                {
                    double calPercentage = 0; double calPercentageYTD = 0;

                    var tuple_get_CurrentMonthTotal = SFA_GET_Enquiries_SalesmanTotal.get_All_ITotal_TableRun_s
                        (DynAx, firstDayOfMonth, currentDate);

                    var monthlyBudget = SalesReport_Get_Budget.getPeriodName(DynAx, monthlyPeriodName, getEmplDetails.Item3[i]);

                    var yearlyPeriodName = SalesReport_Get_Budget.getStartDateToDateYearly(DynAx, lastDayOfMonth);
                    double yearlyBudgetYTD = SalesReport_Get_Budget.getPeriodNameYearly(DynAx, yearlyPeriodName.Item2, yearlyPeriodName.Item3, getEmplDetails.Item3[i]);
                    yearlyBudget = SalesReport_Get_Budget.getPeriodNameYearly_OtherDiv(DynAx, getEmplDetails.Item3[i]);

                    var get_Total = SFA_GET_Enquiries_SalesmanTotal.getAllTotal(DynAx, firstDayOfYear, currentDate);

                    double totalAmount = get_Total.Item1;

                    Tuple<List<string>, string, int> getCustAcc = SalesReport_Get_Budget.GetCustTable(DynAx);

                    lblGetDtRange.Text = "MTD : " + firstDayOfMonth + " - " + currentDate +
                                    "<br> YTD : " + firstDayOfYear + " - " + currentDate;

                    for (int j = 0; j < getCustAcc.Item3; j++)
                    {
                        var invoiceSalesMonthly = SalesReport_Get_Budget.GetSalesOrder_OtherDiv(DynAx, getCustAcc.Item1[j], firstDayOfMonth, currentDate);
                        if (invoiceSalesMonthly.Item1.ToString() != "0")
                        {
                            totalSalesOrder.Add(invoiceSalesMonthly.Item1);
                        }
                    }
                    sumSalesOrder += totalSalesOrder.Sum();

                    totalInvoicedSales.Add(tuple_get_CurrentMonthTotal.Item1);
                    totalInvoiceSalesYTD.Add(totalAmount);

                    totalBudget.Add((int)Convert.ToInt64(monthlyBudget.Item1));
                    totalBudgetYTD.Add((int)Convert.ToInt64(yearlyBudgetYTD));

                    if (tuple_get_CurrentMonthTotal.Item1 != 0 && monthlyBudget.Item1 != 0)
                    {
                        calPercentage = tuple_get_CurrentMonthTotal.Item1 / monthlyBudget.Item1 * 100;
                    }

                    if (totalAmount != 0 && yearlyBudgetYTD != 0)
                    {
                        calPercentageYTD = totalAmount / yearlyBudgetYTD * 100;
                    }
                }

                double getTotalAP = 0; double getTotalApYTD = 0;
                lblGetSalesOrder.Text = "MTD : " + sumSalesOrder.ToString("#,###,###,##0.00");
                AddPrivateLog("Sales Order = " + lblGetSalesOrder.Text);

                double getInvoiceSales = totalInvoicedSales.Sum();
                double getTotalInvoiceSalesYTD = totalInvoiceSalesYTD.Sum();
                lblGetInvoiceSales.Text = "MTD : " + getInvoiceSales.ToString("#,###,###,##0.00") +
                                     "<br> YTD : " + getTotalInvoiceSalesYTD.ToString("#,###,###,##0.00");
                AddPrivateLog("Invoiced Sales = " + lblGetInvoiceSales.Text);

                int getTotalBudget = totalBudget.Sum();
                int getTotalBudgetYTD = totalBudgetYTD.Sum();
                lblGetBudget.Text = "MTD : " + getTotalBudget.ToString("#,###,###,##0.00") +
                               "<br> YTD : " + getTotalBudgetYTD.ToString("#,###,###,##0.00") +
                               "<br> Yearly : " + yearlyBudget.ToString("#,###,###,##0.00");
                AddPrivateLog("Budget = " + lblGetBudget.Text);

                if (getTotalBudget != 0)
                {
                    getTotalAP = Convert.ToDouble(getInvoiceSales) / Convert.ToDouble(getTotalBudget) * 100;
                }

                if (getTotalBudgetYTD != 0 && getTotalInvoiceSalesYTD != 0)
                {
                    getTotalApYTD = (getTotalInvoiceSalesYTD / Convert.ToDouble(getTotalBudgetYTD)) * 100;
                }

                double getYearlyBudget = 0;
                if (yearlyBudget != 0 && getTotalInvoiceSalesYTD != 0)
                {
                    getYearlyBudget = Convert.ToDouble(getTotalInvoiceSalesYTD) / Convert.ToDouble(yearlyBudget) * 100;
                }

                lblGetPercentage.Text = "MTD : " + getTotalAP.ToString("N2") +
                                   "<br> YTD : " + getTotalApYTD.ToString("N2") +
                                   "<br> Yearly : " + getYearlyBudget.ToString("N2");
                AddPrivateLog("Percentage = " + lblGetPercentage.Text);

                if (Convert.ToDouble(getTotalAP) < 50)
                {
                    lblGetPercentage.ForeColor = Color.Red;
                }//change textcolor to red when percentage is not below 50
            }
            catch (Exception ex)
            {
                Function_Method.AddLog(ex.Message);
                throw;
            }
        }

        protected string GetGridviewData()
        {
            StringBuilder strBuilder = new StringBuilder();
            StringWriter strWriter = new StringWriter(strBuilder);
            HtmlTextWriter htw = new HtmlTextWriter(strWriter);

            // Get the container div element by its ID
            var container = gridviewReport.FindControl("salesreport") as HtmlGenericControl;

            container.RenderControl(htw);

            return strBuilder.ToString();
        }

        protected void GetEmailInfo(string receiver, string hod1, string hod2, string hod3, string hod4)
        {
            Function_Method.isVPPPCampaign = false;

            string MailSubject; string Sendmsg = "";

            MailSubject = "YTD Sales Report for " + hdsalesman.Value.ToString();
            Sendmsg = GetGridviewData();
            string MailTo = receiver;//recipient
            Function_Method.SendMail("mailadmin", "Administrator", MailSubject, MailTo, hod1 + "," + hod2 + "," + hod3 + "," + hod4, Sendmsg);
            Flag = true;
        }

        public override void VerifyRenderingInServerForm(System.Web.UI.Control control)
        {
            /* Verifies that the control is rendered */
        }

        public static void InsertSQL(string emplid)
        {
            MySqlConnection conn = new MySqlConnection(GLOBAL.connStr);
            string query = "insert into email_tbl(emp_ID,is_Send,send_DateTime) values (@v1,@v2,@v3)";

            MySqlCommand cmd = new MySqlCommand(query, conn);

            MySqlParameter _v1 = new MySqlParameter("@v1", MySqlDbType.VarChar, 0);
            _v1.Value = emplid;
            cmd.Parameters.Add(_v1);

            MySqlParameter _v2 = new MySqlParameter("@v2", MySqlDbType.VarChar, 0);
            _v2.Value = Flag.ToString();
            cmd.Parameters.Add(_v2);

            MySqlParameter _v3 = new MySqlParameter("@v3", MySqlDbType.VarChar, 0);
            _v3.Value = DateTime.Now.ToString();
            cmd.Parameters.Add(_v3);

            conn.Open();
            cmd.ExecuteNonQuery();

            conn.Close();
            cmd.Parameters.Clear();
            conn.Dispose();
        }

        private static void AddPrivateLog(string text)
        {
            using (StreamWriter writer = new StreamWriter("C:\\Users\\Administrator\\Desktop\\publishDotNet\\Daily.log", true))
            {
                writer.WriteLine(DateTime.Now + " " + text);
            }
        }
    }
}