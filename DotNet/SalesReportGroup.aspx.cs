using GLOBAL_FUNCTION;
using GLOBAL_VAR;
using Microsoft.Dynamics.BusinessConnectorNet;
using System;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace DotNet
{
    public partial class SalesReportGroup : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            Function_Method.isWarranty = false;//bcc Keegan
            Function_Method.isPBM = false;
            Function_Method.isVPPPCampaign = false;
            GLOBAL.switch_Company = "PPM"; GLOBAL.user_id = GLOBAL.AdminID;
            Axapta DynAx = Function_Method.GlobalAxapta();
            Function_Method.AddLog("PPM Group Sales Report");

            lblAutoGenerated.Text = SalesReport_Get_Budget.autoGen;

            ExecuteByGroup(DynAx, SalesReport_Get_Budget.now);
        }

        protected void ExecuteByGroup(Axapta DynAx, DateTime now)
        {
            Regex regex = new Regex(@"^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$",
                RegexOptions.CultureInvariant | RegexOptions.Singleline);
            int count = 0;
            try
            {
                var getGroupCode = SalesReport_Get_Budget.GetGroupCode(DynAx);

                for (int i = 0; i < getGroupCode.Item5; i++)//count group code
                {
                    var getEmpGroup = SalesReport_Get_Budget.getEmpDetailsFilterSalesAppGrp(DynAx, getGroupCode.Item6[i]);

                    if (!string.IsNullOrEmpty(getEmpGroup.Item6[0]) && regex.IsMatch(getEmpGroup.Item6[0]))
                    {
                        WeeklySalesReportGroup(DynAx, getGroupCode.Item6[i], now);
                        //MonthlySalesReportGroup(DynAx, getGroupCode.Item6[i]);
                        Debug.WriteLine(getEmpGroup.Item6[0]);
                        var getHODemailGroup = SalesReport_Get_Budget.get_HODemplIdLvl(DynAx, getGroupCode.Item6[i]);
                        GetEmailInfo(getHODemailGroup.Item1, getHODemailGroup.Item2, getHODemailGroup.Item3, getHODemailGroup.Item4, getEmpGroup.Item7);
                        SalesReport.InsertSQL("PPM Group - " + getGroupCode.Item6[i]);
                        Function_Method.AddLog("- " + "PPM Group - " + getGroupCode.Item6[i]);

                        count++;
                    }
                }
                Function_Method.AddLog("- " + count.ToString() + " PPM salesman group email sent completed.");
            }
            catch (Exception ex)
            {
                Function_Method.AddLog("> Error: " + ex.Message);
                throw;
            }
        }

        protected void WeeklySalesReportGroup(Axapta DynAx, string approvalLvl, DateTime now)
        {
            var currentDate = new DateTime(now.Year, now.Month, now.Day).ToString("dd/MM/yyyy");
            var firstDayOfYear = new DateTime(now.Year, 1, 1).ToString("dd/MM/yyyy");
            var firstDayOfMonth = new DateTime(now.Year, now.Month, 1).ToString("dd/MM/yyyy");
            var lastDayOfMonth = new DateTime(now.Year, now.Month, DateTime.DaysInMonth(now.Year, now.Month)).ToString("dd/MM/yyyy");

            lblDescribes.Text = "Following describes the Sales Report for the following Sales ID on ";
            lblDate.Text = firstDayOfMonth;

            try
            {
                DataTable dt = new DataTable();
                int data_count = 5;
                string[] N = new string[data_count];

                N[0] = "Sales ID"; N[1] = "Date Range"; N[2] = "Current";
                N[3] = "Budget"; N[4] = "Achieve Percentage(%)";
                for (int i = 0; i < data_count; i++)
                {
                    dt.Columns.Add(new DataColumn(N[i], typeof(string)));
                }

                var getEmpFilterGroup = SalesReport_Get_Budget.getEmpDetailsFilterSalesAppGrp(DynAx, approvalLvl);

                List<double> totalSalesOder = new List<double>();
                List<int> totalInvoicedSales = new List<int>();
                List<int> totalInvoiceSalesYTD = new List<int>();
                List<int> totalBudget = new List<int>();
                List<int> totalBudgetYTD = new List<int>();

                DataRow row;
                int countCurrent = 0;
                for (int i = 0; i < getEmpFilterGroup.Item5; i++)
                {
                    double calPercentage = 0; double calPercentageYTD = 0;

                    var tuple_get_CurrentMonthTotal = SFA_GET_Enquiries_SalesmanTotal.get_ITotal_TableRun_s
                        (DynAx, getEmpFilterGroup.Item4[i], firstDayOfMonth, currentDate);

                    string monthlyPeriodName = SalesReport_Get_Budget.getStartDateToDate(DynAx, lastDayOfMonth);
                    if (string.IsNullOrEmpty(monthlyPeriodName))
                    {
                        monthlyPeriodName = "-";//assign - to avoid getting wrong periodname in salesbudget
                    }
                    var monthlyBudget = SalesReport_Get_Budget.getPeriodName(DynAx, monthlyPeriodName, getEmpFilterGroup.Item4[i]);

                    var yearlyPeriodName = SalesReport_Get_Budget.getStartDateToDateYearly(DynAx, lastDayOfMonth);
                    double yearlyBudget = SalesReport_Get_Budget.getPeriodNameYearly(DynAx, yearlyPeriodName.Item2, yearlyPeriodName.Item3, getEmpFilterGroup.Item4[i]);

                    var get_Total = SFA_GET_Enquiries_SalesmanTotal.getTotal
                        (DynAx, getEmpFilterGroup.Item4[i], firstDayOfYear, currentDate);
                    double totalAmount = get_Total.Item1;

                    row = dt.NewRow();
                    row["Sales ID"] = getEmpFilterGroup.Item4[i] + " " + getEmpFilterGroup.Item1[i];
                    row["Date Range"] = firstDayOfMonth + " - " + currentDate + "<br>" + "<br>" +
                                        firstDayOfYear + " - " + currentDate;

                    row["Current"] = tuple_get_CurrentMonthTotal.Item1.ToString("#,###,###,##0") + " (" + tuple_get_CurrentMonthTotal.Item4 + ")" +
                                         "<br>" + "<br>" + totalAmount.ToString("#,###,###,##0") + " (" + get_Total.Item2 + ")";
                    totalInvoicedSales.Add(Convert.ToInt32(tuple_get_CurrentMonthTotal.Item1));
                    totalInvoiceSalesYTD.Add(Convert.ToInt32(totalAmount));
                    countCurrent = countCurrent + get_Total.Item2;

                    row["Budget"] = monthlyBudget.Item1.ToString("#,###,###,##0") + "<br>" + "<br>" + yearlyBudget.ToString("#,###,###,##0");
                    totalBudget.Add(Convert.ToInt32(monthlyBudget.Item1));
                    totalBudgetYTD.Add(Convert.ToInt32(yearlyBudget));

                    if (tuple_get_CurrentMonthTotal.Item1 != 0 && monthlyBudget.Item1 != 0)
                    {
                        calPercentage = tuple_get_CurrentMonthTotal.Item1 / monthlyBudget.Item1 * 100;
                    }

                    if (totalAmount != 0 && yearlyBudget != 0)
                    {
                        calPercentageYTD = totalAmount / yearlyBudget * 100;
                    }

                    row["Achieve Percentage(%)"] = calPercentage.ToString("N2") + "<br>" + "<br>" + calPercentageYTD.ToString("N2");
                    dt.Rows.Add(row);
                }

                row = dt.NewRow();
                double calTotalPercentage = 0; double calTotalPercentageYTD = 0;

                row["Sales ID"] = "Total";
                row["Date Range"] = firstDayOfMonth + " - " + currentDate + "<br>" + "<br>" +
                                    firstDayOfYear + " - " + currentDate;

                int getInvoiceSales = totalInvoicedSales.Sum();
                int getTotalInvoiceSalesYTD = totalInvoiceSalesYTD.Sum();
                row["Current"] = getInvoiceSales.ToString("#,###,###,##0") + "<br>" + "<br>" + getTotalInvoiceSalesYTD.ToString("#,###,###,##0");

                int getTotalBudget = totalBudget.Sum();
                int getTotalBudgetYTD = totalBudgetYTD.Sum();
                row["Budget"] = getTotalBudget.ToString("#,###,###,##0") + "<br>" + "<br>" + getTotalBudgetYTD.ToString("#,###,###,##0");

                if (getTotalBudget != 0)
                {
                    calTotalPercentage = Convert.ToDouble(getInvoiceSales) / Convert.ToDouble(getTotalBudget) * 100;
                }

                if (getTotalBudgetYTD != 0 && getTotalInvoiceSalesYTD != 0)
                {
                    calTotalPercentageYTD = Convert.ToDouble(getTotalInvoiceSalesYTD) / Convert.ToDouble(getTotalBudgetYTD) * 100;
                }

                row["Achieve Percentage(%)"] = calTotalPercentage.ToString("N2") + "<br>" + "<br>" + calTotalPercentageYTD.ToString("N2");

                dt.Rows.Add(row);
                gvReportGroup.DataSource = dt;
                gvReportGroup.DataBind();

                int row_count = gvReportGroup.Rows.Count;
                string[] result; string[] delim = { "<br><br>" };
                for (int i = 0; i < row_count; i++)
                {
                    string percentage = gvReportGroup.Rows[i].Cells[4].Text;
                    Debug.WriteLine(percentage);
                    result = percentage.Split(delim, StringSplitOptions.None);
                    if (Convert.ToDouble(result[0]) < 50)
                    {
                        gvReportGroup.Rows[i].Cells[4].Text = "<span style='color:red'>" + result[0] + "</span><br><br>" + result[1];

                        if (Convert.ToDouble(result[1]) < 50)
                        {
                            gvReportGroup.Rows[i].Cells[4].Text = "<span style='color:red'>" + result[0] + "<br><br><span style='color:red'>" + result[1] + "</span>";
                        }
                    }//change textcolor to red when percentage is not below 50

                    else if (Convert.ToDouble(result[1]) < 50)
                    {
                        gvReportGroup.Rows[i].Cells[4].Text = result[0] + "<br><br><span style='color:red'>" + result[1] + "</span>";
                    }
                }
            }
            catch (Exception)
            {
                throw;
            }
        }

        protected void MonthlySalesReportGroup(Axapta DynAx, string approvalLvl)
        {
            DateTime now = DateTime.Now;
            var firstDayOfYear = new DateTime(now.Year, 1, 1).ToString("dd/MM/yyyy");
            var firstDayOfMonth = new DateTime(now.Year, now.Month, 1).ToString("dd/MM/yyyy");
            var lastDayOfMonth = new DateTime(now.Year, now.Month, DateTime.DaysInMonth(now.Year, now.Month)).ToString("dd/MM/yyyy");

            lblDescribes.Text = "Following describes the Sales Report for the following Sales ID on ";
            lblDate.Text = firstDayOfMonth;

            try
            {
                DataTable dt = new DataTable();
                int data_count = 5;
                string[] N = new string[data_count];

                N[0] = "Sales ID"; N[1] = "Date Range"; N[2] = "Current";
                N[3] = "Budget"; N[4] = "Achieve Percentage(%)";
                for (int i = 0; i < data_count; i++)
                {
                    dt.Columns.Add(new DataColumn(N[i], typeof(string)));
                }

                var getEmpFilterGroup = SalesReport_Get_Budget.getEmpDetailsFilterSalesAppGrp(DynAx, approvalLvl);

                List<double> totalSalesOder = new List<double>();
                List<int> totalInvoicedSales = new List<int>();
                List<int> totalInvoiceSalesYTD = new List<int>();
                List<int> totalBudget = new List<int>();
                List<int> totalBudgetYTD = new List<int>();

                DataRow row;
                int countCurrent = 0;
                for (int i = 0; i < getEmpFilterGroup.Item5; i++)
                {
                    double calPercentage = 0; double calPercentageYTD = 0;

                    var tuple_get_CurrentMonthTotal = SFA_GET_Enquiries_SalesmanTotal.get_ITotal_TableRun_s
                        (DynAx, getEmpFilterGroup.Item4[i], firstDayOfMonth, lastDayOfMonth);

                    string monthlyPeriodName = SalesReport_Get_Budget.getStartDateToDate(DynAx, lastDayOfMonth);
                    if (string.IsNullOrEmpty(monthlyPeriodName))
                    {
                        monthlyPeriodName = "-";//assign - to avoid getting wrong periodname in salesbudget
                    }
                    var monthlyBudget = SalesReport_Get_Budget.getPeriodName(DynAx, monthlyPeriodName, getEmpFilterGroup.Item4[i]);

                    var yearlyPeriodName = SalesReport_Get_Budget.getStartDateToDateYearly(DynAx, lastDayOfMonth);
                    double yearlyBudget = SalesReport_Get_Budget.getPeriodNameYearly(DynAx, yearlyPeriodName.Item2, yearlyPeriodName.Item3, getEmpFilterGroup.Item4[i]);

                    var get_Total = SFA_GET_Enquiries_SalesmanTotal.getTotal
                        (DynAx, getEmpFilterGroup.Item4[i], firstDayOfYear, lastDayOfMonth);
                    double totalAmount = get_Total.Item1;

                    row = dt.NewRow();
                    row["Sales ID"] = getEmpFilterGroup.Item4[i] + " " + getEmpFilterGroup.Item1[i];
                    row["Date Range"] = firstDayOfMonth + " - " + lastDayOfMonth + "<br>" + "<br>" +
                                        firstDayOfYear + " - " + lastDayOfMonth;

                    row["Current"] = tuple_get_CurrentMonthTotal.Item1.ToString("#,###,###,##0") + " (" + tuple_get_CurrentMonthTotal.Item4 + ")" +
                                         "<br>" + "<br>" + totalAmount.ToString("#,###,###,##0") + " (" + get_Total.Item2 + ")";
                    totalInvoicedSales.Add(Convert.ToInt32(tuple_get_CurrentMonthTotal.Item1));
                    totalInvoiceSalesYTD.Add(Convert.ToInt32(totalAmount));
                    countCurrent = countCurrent + get_Total.Item2;

                    row["Budget"] = monthlyBudget.Item1.ToString("#,###,###,##0") + "<br>" + "<br>" + yearlyBudget.ToString("#,###,###,##0");
                    totalBudget.Add(Convert.ToInt32(monthlyBudget.Item1));
                    totalBudgetYTD.Add(Convert.ToInt32(yearlyBudget));

                    if (tuple_get_CurrentMonthTotal.Item1 != 0 && monthlyBudget.Item1 != 0)
                    {
                        calPercentage = tuple_get_CurrentMonthTotal.Item1 / monthlyBudget.Item1 * 100;
                    }

                    if (totalAmount != 0 && yearlyBudget != 0)
                    {
                        calPercentageYTD = totalAmount / yearlyBudget * 100;
                    }

                    row["Achieve Percentage(%)"] = calPercentage.ToString("N2") + "<br>" + "<br>" + calPercentageYTD.ToString("N2");
                    dt.Rows.Add(row);
                }

                row = dt.NewRow();
                double calTotalPercentage = 0; double calTotalPercentageYTD = 0;

                row["Sales ID"] = "Total<span style='color: red;'>(Exclude - 2)</span>";
                row["Date Range"] = firstDayOfMonth + " - " + lastDayOfMonth + "<br>" +
                                    firstDayOfYear + " - " + lastDayOfMonth;

                int getInvoiceSales = totalInvoicedSales.Where((value, index) => index != 2).Sum();
                int getTotalInvoiceSalesYTD = totalInvoiceSalesYTD.Where((value, index) => index != 2).Sum();
                row["Current"] = getInvoiceSales.ToString("#,###,###,##0") + "<br>" + getTotalInvoiceSalesYTD.ToString("#,###,###,##0");

                int getTotalBudget = totalBudget.Where((value, index) => index != 2).Sum();
                int getTotalBudgetYTD = totalBudgetYTD.Where((value, index) => index != 2).Sum();
                row["Budget"] = getTotalBudget.ToString("#,###,###,##0") + "<br>" + getTotalBudgetYTD.ToString("#,###,###,##0");
                if (getTotalBudget != 0)
                {
                    calTotalPercentage = Convert.ToDouble(getInvoiceSales) / Convert.ToDouble(getTotalBudget) * 100;
                }

                if (getTotalBudgetYTD != 0 && getTotalInvoiceSalesYTD != 0)
                {
                    calTotalPercentageYTD = Convert.ToDouble(getTotalInvoiceSalesYTD) / Convert.ToDouble(getTotalBudgetYTD) * 100;
                }

                row["Achieve Percentage(%)"] = calTotalPercentage.ToString("N2") + "<br>" + "<br>" + calTotalPercentageYTD.ToString("N2");

                dt.Rows.Add(row);
                gvReportGroup.DataSource = dt;
                gvReportGroup.DataBind();

                int row_count = gvReportGroup.Rows.Count;
                string[] result; string[] delim = { "<br><br>" };
                for (int i = 0; i < row_count; i++)
                {
                    string percentage = gvReportGroup.Rows[i].Cells[4].Text;
                    //Debug.WriteLine(percentage);
                    result = percentage.Split(delim, StringSplitOptions.None);
                    if (Convert.ToDouble(result[0]) < 50)
                    {
                        gvReportGroup.Rows[i].Cells[4].Text = "<span style='color:red'>" + result[0] + "</span><br><br>" + result[1];

                        if (Convert.ToDouble(result[1]) < 50)
                        {
                            gvReportGroup.Rows[i].Cells[4].Text = "<span style='color:red'>" + result[0] + "<br><br><span style='color:red'>" + result[1] + "</span>";
                        }
                    }//change textcolor to red when percentage is not below 50

                    else if (Convert.ToDouble(result[1]) < 50)
                    {
                        gvReportGroup.Rows[i].Cells[4].Text = result[0] + "<br><br><span style='color:red'>" + result[1] + "</span>";
                    }
                }

            }
            catch (Exception)
            {
                throw;
            }
        }

        protected string GetGridviewData(GridView gv)
        {
            StringBuilder strBuilder = new StringBuilder();
            StringWriter strWriter = new StringWriter(strBuilder);
            HtmlTextWriter htw = new HtmlTextWriter(strWriter);
            gridviewReport.RenderControl(htw);

            return strBuilder.ToString();
        }

        protected void GetEmailInfo(string receiver, string hod2, string hod3, string hod4, string groupHOD)
        {
            Function_Method.isVPPPCampaign = false;
            string MailSubject; string Sendmsg = "";

            MailSubject = "Sales Report for Group " + groupHOD;
            Sendmsg = GetGridviewData(gvReportGroup);

            string MailTo = receiver;//recipient
            Function_Method.SendMail("mailadmin", "Administrator", MailSubject, MailTo, hod2 + "," + hod3 + "," + hod4, Sendmsg);
            SalesReport.Flag = true;
        }

        public override void VerifyRenderingInServerForm(System.Web.UI.Control control)
        {
            /* Verifies that the control is rendered */
        }

    }
}