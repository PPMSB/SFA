using GLOBAL_FUNCTION;
using GLOBAL_VAR;
using Microsoft.Dynamics.BusinessConnectorNet;
using MySql.Data.MySqlClient;
using System;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace DotNet
{
    public partial class SalesReport : System.Web.UI.Page
    {
        public static bool Flag;
        protected void Page_Load(object sender, EventArgs e)
        {
            Function_Method.isWarranty = false;//bcc Keegan

            Function_Method.isPBM = false;

            GLOBAL.switch_Company = "PPM"; GLOBAL.user_id = GLOBAL.AdminID;
            Axapta DynAx = Function_Method.GlobalAxapta();
            Function_Method.AddLog("PPM Sales Report");

            lblAutoGenerated.Text = SalesReport_Get_Budget.autoGen;

            Execute(DynAx, SalesReport_Get_Budget.now);
        }

        private void Execute(Axapta DynAx, DateTime now)
        {
            string salesmanID = ""; string temp_email = ""; int count = 0;
            try
            {
                List<ListItem> items = new List<ListItem>();
                List<string> email = new List<string>();
                items = SalesReport_Get_Budget.getSalesman(DynAx);
                for (int i = 0; i < items.Count; i++)
                {
                    Regex regex = new Regex(@"^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$",
                        RegexOptions.CultureInvariant | RegexOptions.Singleline);

                    var salesman = items[i];
                    salesmanID = salesman.Value;
                    var getEmplDetails = SalesReport_Get_Budget.getEmpDetails(DynAx, salesmanID);
                    hdsalesman.Value = getEmplDetails.Item1;

                    var getEmail = SalesReport_Get_Budget.getEmpDetails2(DynAx, getEmplDetails.Item6);

                    if (temp_email != getEmplDetails.Item6 && !string.IsNullOrEmpty(getEmail.Item5[0]))// check salesman second account/check email is empty or not
                    {
                        if (regex.IsMatch(getEmail.Item5[0]) && !email.Contains(getEmplDetails.Item6))// validate email/check for existed email
                        {
                            email.Add(getEmplDetails.Item6);//store first email
                            WeeklySalesReport(DynAx, salesmanID, now);
                            temp_email = getEmplDetails.Item6;//set it to temp for second account checking purposes
                            Debug.WriteLine(salesmanID);
                            //var empDetails = SalesReport_Get_Budget.getEmpDetails(DynAx, salesmanID);

                            var getHODemail = SalesReport_Get_Budget.get_HODemplIdLvl(DynAx, getEmplDetails.Item7.ToString());
                            if (SalesReport_Get_Budget.getSkipHODstatus(DynAx, salesmanID) == "1")
                            {
                                GetEmailInfo(getEmplDetails.Item6, "", "", "", "");
                                Function_Method.AddLog("- " + "PPM skip HOD" + getEmplDetails.Item6);
                            }
                            else
                            {
                                GetEmailInfo(getEmplDetails.Item6, getHODemail.Item1, getHODemail.Item2, getHODemail.Item3, getHODemail.Item4);
                            }
                            InsertSQL("PPM " + getEmplDetails.Item6);
                            Function_Method.AddLog("- " + "PPM " + getEmplDetails.Item6);

                            gvReport.Dispose();
                            count++;
                        }
                    }
                    regex = null;
                    getEmplDetails = null;
                    getEmail = null;
                }
                Function_Method.AddLog("- " + count.ToString() + " PPM individual email sent completed.");
            }
            catch (Exception ex)
            {
                Function_Method.AddLog("> Error: " + ex.Message);
                throw;
            }
            finally
            {
                DynAx.Dispose();
            }
        }

        protected void WeeklySalesReport(Axapta DynAx, string SalesmanID, DateTime now)
        {
            var currentDate = new DateTime(now.Year, now.Month, now.Day).ToString("dd/MM/yyyy");
            var firstDayOfYear = new DateTime(now.Year, 1, 1).ToString("dd/MM/yyyy");
            var firstDayOfMonth = new DateTime(now.Year, now.Month, 1).ToString("dd/MM/yyyy");
            var lastDayOfMonth = new DateTime(now.Year, now.Month, DateTime.DaysInMonth(now.Year, now.Month)).ToString("dd/MM/yyyy");

            lblDescribes.Text = "Following describes the Sales Report for the following Sales ID on ";
            lblDate.Text = currentDate;

            try
            {
                DataTable dt = new DataTable();
                int data_count = 6;
                string[] N = new string[data_count];

                N[0] = "Sales ID"; N[1] = "Date Range"; N[2] = "Open Order (#Customer)";
                N[3] = "Invoiced Sales (#Customer)"; N[4] = "Budget"; N[5] = "Achieve Percentage(%)";
                for (int i = 0; i < data_count; i++)
                {
                    dt.Columns.Add(new DataColumn(N[i], typeof(string)));
                }

                var getEmplDetails = SalesReport_Get_Budget.getEmpDetails(DynAx, SalesmanID);

                var getEmail = SalesReport_Get_Budget.getEmpDetails2(DynAx, getEmplDetails.Item6);
                List<double> totalSalesOrder = new List<double>();
                List<int> sumSalesOrder = new List<int>();
                List<int> totalInvoicedSales = new List<int>();
                List<double> totalInvoiceSalesYTD = new List<double>();
                List<int> totalBudget = new List<int>();
                List<int> totalBudgetYTD = new List<int>();

                DataRow row;
                //int OpenOrder = 0; int invoiceSales = 0;
                int getCustomerOpenOrder = 0;
                string monthlyPeriodName = SalesReport_Get_Budget.getStartDateToDate(DynAx, lastDayOfMonth);

                for (int i = 0; i < getEmail.Item4; i++)//count salesman email
                {
                    double calPercentage = 0; double calPercentageYTD = 0;

                    var tuple_get_CurrentMonthTotal = SFA_GET_Enquiries_SalesmanTotal.get_ITotal_TableRun_s
                        (DynAx, getEmail.Item3[i], firstDayOfMonth, currentDate);

                    var monthlyBudget = SalesReport_Get_Budget.getPeriodName(DynAx, monthlyPeriodName, getEmail.Item3[i]);

                    var yearlyPeriodName = SalesReport_Get_Budget.getStartDateToDateYearly(DynAx, lastDayOfMonth);
                    double yearlyBudget = SalesReport_Get_Budget.getPeriodNameYearly(DynAx, yearlyPeriodName.Item2, yearlyPeriodName.Item3, getEmail.Item3[i]);

                    var get_Total = SFA_GET_Enquiries_SalesmanTotal.getTotal
                        (DynAx, getEmail.Item3[i], firstDayOfYear, currentDate);
                    double totalAmount = get_Total.Item1;

                    var getCustAcc = Payment_GET_Ledger_Journal_Table.get_CustTable(DynAx, getEmail.Item3[i]);

                    row = dt.NewRow();
                    row["Sales ID"] = getEmail.Item3[i];
                    row["Date Range"] = firstDayOfMonth + " - " + currentDate + "<br>" + "<br>" +
                                        firstDayOfYear + " - " + currentDate;

                    row["Open Order (#Customer)"] = "<br>" + "<br>" + "0" + " (" + "0" + ")";
                    totalSalesOrder.Clear();
                    int count = 0;
                    for (int j = 0; j < getCustAcc.Item3; j++)
                    {
                        var invoiceSalesMonthly = SalesReport_Get_Budget.getSalesOrder(DynAx, getCustAcc.Item1[j], firstDayOfYear, lastDayOfMonth);
                        totalSalesOrder.Add(Convert.ToInt32(invoiceSalesMonthly.Item1));
                        if (invoiceSalesMonthly.Item2 != 0)
                        {
                            count++;
                            row["Open Order (#Customer)"] = "<br>" + "<br>" + totalSalesOrder.Sum().ToString("N0") + " (" + count + ")";
                            getCustomerOpenOrder = invoiceSalesMonthly.Item2;
                        }
                    }
                    //OpenOrder = OpenOrder + getCustomerOpenOrder;//count customer of open order
                    sumSalesOrder.Add(Convert.ToInt32(totalSalesOrder.Sum()));

                    row["Invoiced Sales (#Customer)"] = tuple_get_CurrentMonthTotal.Item1.ToString("#,###,###,##0") + " (" + tuple_get_CurrentMonthTotal.Item4 + ")" +
                                         "<br>" + "<br>" + totalAmount.ToString("#,###,###,##0") + " (" + get_Total.Item2 + ")";
                    totalInvoicedSales.Add(Convert.ToInt32(tuple_get_CurrentMonthTotal.Item1));
                    totalInvoiceSalesYTD.Add(Convert.ToDouble(totalAmount));
                    //invoiceSales = invoiceSales + tuple_get_CurrentMonthTotal.Item4;//count customer of invoice sales

                    row["Budget"] = monthlyBudget.Item1.ToString("#,###,###,##0") +
                                  "<br>" + "<br>" + yearlyBudget.ToString("#,###,###,##0");
                    totalBudget.Add(Convert.ToInt32(monthlyBudget.Item1));
                    totalBudgetYTD.Add(Convert.ToInt32(yearlyBudget));

                    if (tuple_get_CurrentMonthTotal.Item1 != 0 && monthlyBudget.Item1 != 0)
                    {
                        calPercentage = tuple_get_CurrentMonthTotal.Item1 / monthlyBudget.Item1 * 100;
                    }

                    if (totalAmount != 0 && yearlyBudget != 0)
                    {
                        calPercentageYTD = totalAmount / yearlyBudget * 100;
                    }

                    row["Achieve Percentage(%)"] = calPercentage.ToString("N2") + "<br>" + "<br>" + calPercentageYTD.ToString("N2");
                    dt.Rows.Add(row);
                }

                row = dt.NewRow();
                double getTotalAP = 0; double getTotalApYTD = 0;

                row["Sales ID"] = "Total<span style='color: red;'>(Exclude - 2)</span>";
                row["Date Range"] = firstDayOfMonth + " - " + currentDate + "<br>" + "<br>" +
                                    firstDayOfYear + " - " + currentDate;

                row["Open Order (#Customer)"] = "<br>" + "<br>" + sumSalesOrder.Take(2).Sum().ToString("#,###,###,##0");

                int getInvoiceSales = totalInvoicedSales.Where((value, index) => index != 2).Sum();
                double getTotalInvoiceSalesYTD = totalInvoiceSalesYTD.Where((value, index) => index != 2).Sum();//exclude the -2 account total for invoice sales 30/4/24
                row["Invoiced Sales (#Customer)"] = getInvoiceSales.ToString("#,###,###,##0") + "<br>" + "<br>" +
                                        getTotalInvoiceSalesYTD.ToString("#,###,###,##0");

                int getTotalBudget = totalBudget.Where((value, index) => index != 2).Sum();
                int getTotalBudgetYTD = totalBudgetYTD.Where((value, index) => index != 2).Sum();
                row["Budget"] = getTotalBudget.ToString("#,###,###,##0") + "<br>" + "<br>" + getTotalBudgetYTD.ToString("#,###,###,##0");
                if (getTotalBudget != 0)
                {
                    getTotalAP = Convert.ToDouble(getInvoiceSales) / Convert.ToDouble(getTotalBudget) * 100;
                }

                if (getTotalBudgetYTD != 0 && getTotalInvoiceSalesYTD != 0)
                {
                    getTotalApYTD = Convert.ToDouble(getTotalInvoiceSalesYTD) / Convert.ToDouble(getTotalBudgetYTD) * 100;
                }

                row["Achieve Percentage(%)"] = getTotalAP.ToString("N2") + "<br>" + "<br>" + getTotalApYTD.ToString("N2");

                dt.Rows.Add(row);
                gvReport.DataSource = dt;
                gvReport.DataBind();

                int row_count = gvReport.Rows.Count;
                string[] result; string[] delim = { "<br><br>" };
                for (int i = 0; i < row_count; i++)
                {
                    string percentage = gvReport.Rows[i].Cells[5].Text;
                    //Debug.WriteLine(percentage);
                    result = percentage.Split(delim, StringSplitOptions.None);
                    if (Convert.ToDouble(result[0]) < 50)
                    {
                        gvReport.Rows[i].Cells[5].Text = "<span style='color:red'>" + result[0] + "</span><br><br>" + result[1];

                        if (Convert.ToDouble(result[1]) < 50)
                        {
                            gvReport.Rows[i].Cells[5].Text = "<span style='color:red'>" + result[0] + "<br><br><span style='color:red'>" + result[1] + "</span>";
                        }
                    }//change textcolor to red when percentage is not below 50

                    else if (Convert.ToDouble(result[1]) < 50)
                    {
                        gvReport.Rows[i].Cells[5].Text = result[0] + "<br><br><span style='color:red'>" + result[1] + "</span>";
                    }
                }
            }
            catch (Exception)
            {
                throw;
            }
        }

        protected string GetGridviewData(GridView gv)
        {
            StringBuilder strBuilder = new StringBuilder();
            StringWriter strWriter = new StringWriter(strBuilder);
            HtmlTextWriter htw = new HtmlTextWriter(strWriter);
            gridviewReport.RenderControl(htw);

            return strBuilder.ToString();
        }

        protected void GetEmailInfo(string receiver, string hod1, string hod2, string hod3, string hod4)
        {
            string MailSubject; string Sendmsg = "";

            MailSubject = "Current Month Sales Report for " + hdsalesman.Value.ToString();
            Sendmsg = GetGridviewData(gvReport);
            string MailTo = receiver;//recipient
            Function_Method.SendMail("mailadmin", "Administrator", MailSubject, MailTo, hod1 + "," + hod2 + "," + hod3 + "," + hod4, Sendmsg);
            Flag = true;
        }

        public override void VerifyRenderingInServerForm(System.Web.UI.Control control)
        {
            /* Verifies that the control is rendered */
        }

        public static void InsertSQL(string emplid)
        {
            MySqlConnection conn = new MySqlConnection(GLOBAL.connStr);
            string query = "insert into email_tbl(emp_ID,is_Send,send_DateTime) values (@v1,@v2,@v3)";

            MySqlCommand cmd = new MySqlCommand(query, conn);

            MySqlParameter _v1 = new MySqlParameter("@v1", MySqlDbType.VarChar, 0);
            _v1.Value = emplid;
            cmd.Parameters.Add(_v1);

            MySqlParameter _v2 = new MySqlParameter("@v2", MySqlDbType.VarChar, 0);
            _v2.Value = Flag.ToString();
            cmd.Parameters.Add(_v2);

            MySqlParameter _v3 = new MySqlParameter("@v3", MySqlDbType.VarChar, 0);
            _v3.Value = DateTime.Now.ToString();
            cmd.Parameters.Add(_v3);

            conn.Open();
            cmd.ExecuteNonQuery();

            conn.Close();
            cmd.Parameters.Clear();
            conn.Dispose();
        }
    }
}