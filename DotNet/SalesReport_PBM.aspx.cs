using GLOBAL_FUNCTION;
using GLOBAL_VAR;
using Microsoft.Dynamics.BusinessConnectorNet;
using System;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Web.UI;
using System.Web.UI.WebControls;

namespace DotNet
{
    public partial class SalesReport_PBM : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            Function_Method.isWarranty = false;//bcc Keegan
            Function_Method.isPBM = true;
            Function_Method.isVPPPCampaign = false;
            GLOBAL.switch_Company = "PBM"; GLOBAL.user_id = GLOBAL.AdminID;
            Axapta DynAx = Function_Method.GlobalAxapta();
            Function_Method.AddLog("PBM Sales Report");

            lblAutoGenerated.Text = SalesReport_Get_Budget.autoGen;

            generate(DynAx, SalesReport_Get_Budget.now);
            Session.Clear();
        }

        private void generate(Axapta DynAx, DateTime now)
        {
            string salesmanID = ""; string temp_email = ""; int count = 0;
            try
            {
                List<ListItem> items = new List<ListItem>();
                List<string> email = new List<string>();
                items = SalesReport_Get_Budget.getSalesman(DynAx);
                for (int i = 0; i < items.Count; i++)
                {
                    Regex regex = new Regex(@"^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$",
                        RegexOptions.CultureInvariant | RegexOptions.Singleline);

                    var salesman = items[i];
                    salesmanID = salesman.Value;
                    var getEmplDetails = SalesReport_Get_Budget.getEmpDetails(DynAx, salesmanID);
                    hdsalesman.Value = getEmplDetails.Item1;

                    var getEmail = SalesReport_Get_Budget.getEmpDetails2(DynAx, getEmplDetails.Item6);

                    if (temp_email != getEmplDetails.Item6 && !string.IsNullOrEmpty(getEmail.Item5[0]))// check salesman second account/check email is empty or not
                    {
                        if (regex.IsMatch(getEmail.Item5[0]) && !email.Contains(getEmplDetails.Item6))// validate email/check for existed email
                        {
                            email.Add(getEmplDetails.Item6);

                            WeeklySalesReportPBM(DynAx, salesmanID, now);

                            temp_email = getEmplDetails.Item6;
                            Debug.WriteLine(salesmanID);
                            //var empDetails = SalesReport_Get_Budget.getEmpDetails(DynAx, salesmanID);

                            var getHODemail = SalesReport_Get_Budget.get_HODemplIdLvl(DynAx, getEmplDetails.Item7.ToString());
                            if (SalesReport_Get_Budget.getSkipHODstatus(DynAx, salesmanID) == "1")
                            {
                                EmailInfo(getEmplDetails.Item6, "", "", "", "");
                                Function_Method.AddLog("- " + "PBM Skip HOD" + salesmanID);
                            }
                            else
                            {
                                EmailInfo(getEmplDetails.Item6, getHODemail.Item1, getHODemail.Item2, getHODemail.Item3, getHODemail.Item4);
                            }
                            SalesReport.InsertSQL("PBM " + salesmanID);
                            Function_Method.AddLog("- " + "PBM " + salesmanID);

                            gvReportPBM.Dispose();
                            count++;
                        }
                    }
                    regex = null;
                    getEmplDetails = null;
                    getEmail = null;
                }
                Function_Method.AddLog("- " + count.ToString() + " PBM individual email sent completed.");
            }
            catch (Exception ex)
            {
                Function_Method.AddLog("> Error: " + ex.Message);
                throw;
            }
            finally
            {
                DynAx.Dispose();
            }
        }

        protected void WeeklySalesReportPBM(Axapta DynAx, string SalesmanID, DateTime now)
        {
            var currentDate = new DateTime(now.Year, now.Month, now.Day).ToString("dd/MM/yyyy");
            var firstDayOfYear = new DateTime(now.Year, 1, 1).ToString("dd/MM/yyyy");
            var firstDayOfMonth = new DateTime(now.Year, now.Month, 1).ToString("dd/MM/yyyy");
            var lastDayOfMonth = new DateTime(now.Year, now.Month, DateTime.DaysInMonth(now.Year, now.Month)).ToString("dd/MM/yyyy");

            lblDescribes.Text = "Following describes the Sales Report for the following Sales ID on ";
            lblDate.Text = currentDate;

            try
            {
                DataTable dt = new DataTable();
                int data_count = 6;
                string[] N = new string[data_count];

                N[0] = "Sales ID"; N[1] = "Date Range"; N[2] = "Open Order (#Customer)";
                N[3] = "Invoiced Sales (#Customer)"; N[4] = "Budget"; N[5] = "Achieve Percentage(%)";
                for (int i = 0; i < data_count; i++)
                {
                    dt.Columns.Add(new DataColumn(N[i], typeof(string)));
                }

                var getEmplDetails = SalesReport_Get_Budget.getEmpDetails(DynAx, SalesmanID);

                var getEmail = SalesReport_Get_Budget.getEmpDetails2(DynAx, getEmplDetails.Item6);
                List<double> totalSalesOrder = new List<double>();
                List<double> sumSalesOrder = new List<double>();
                List<double> totalInvoicedSales = new List<double>();
                List<double> totalInvoiceSalesYTD = new List<double>();
                List<double> totalBudget = new List<double>();
                List<double> totalBudgetYTD = new List<double>();

                DataRow row;
                //int OpenOrder = 0; int invoiceSales = 0;
                int getCustomerOpenOrder = 0;
                string monthlyPeriodName = SalesReport_Get_Budget.getStartDateToDate(DynAx, lastDayOfMonth);

                for (int i = 0; i < getEmail.Item4; i++)//count salesman email
                {
                    double calPercentage = 0; double calPercentageYTD = 0;

                    var tuple_get_CurrentMonthTotal = SFA_GET_Enquiries_SalesmanTotal.get_ITotal_TableRun_s
                        (DynAx, getEmail.Item3[i], firstDayOfMonth, currentDate);
                    if (string.IsNullOrEmpty(monthlyPeriodName))
                    {
                        monthlyPeriodName = "-";//assign - to avoid getting wrong periodname in salesbudget
                    }
                    var monthlyBudget = SalesReport_Get_Budget.getPeriodName(DynAx, monthlyPeriodName, getEmail.Item3[i]);

                    var yearlyPeriodName = SalesReport_Get_Budget.getStartDateToDateYearly(DynAx, lastDayOfMonth);
                    double yearlyBudget = SalesReport_Get_Budget.getPeriodNameYearly(DynAx, yearlyPeriodName.Item2, yearlyPeriodName.Item3, getEmail.Item3[i]);

                    var get_Total = SFA_GET_Enquiries_SalesmanTotal.getTotal
                        (DynAx, getEmail.Item3[i], firstDayOfYear, currentDate);
                    double totalAmount = get_Total.Item1;

                    var getCustAcc = Payment_GET_Ledger_Journal_Table.get_CustTable(DynAx, getEmail.Item3[i]);

                    row = dt.NewRow();
                    row["Sales ID"] = getEmail.Item3[i];

                    row["Date Range"] = firstDayOfMonth + " - " + currentDate + "<br>" + "<br>" +
                                        firstDayOfYear + " - " + currentDate;

                    row["Open Order (#Customer)"] = "<br>" + "<br>" + "0" + " (" + "0" + ")";
                    totalSalesOrder.Clear();
                    int count = 0;
                    for (int j = 0; j < getCustAcc.Item3; j++)
                    {
                        var invoiceSalesMonthly = SalesReport_Get_Budget.getSalesOrder(DynAx, getCustAcc.Item1[j], firstDayOfYear, lastDayOfMonth);
                        //var invoiceSalesMonthly = SalesReport_Get_Budget.getSalesOrder(DynAx, "08090240", firstDayOfYear, lastDayOfMonth);

                        totalSalesOrder.Add(invoiceSalesMonthly.Item1);
                        if (invoiceSalesMonthly.Item2 != 0)
                        {
                            count++;
                            row["Open Order (#Customer)"] = "<br>" + "<br>" + totalSalesOrder.Sum().ToString("N0") + " (" + count + ")";
                            getCustomerOpenOrder = invoiceSalesMonthly.Item2;
                        }
                    }
                    //OpenOrder = OpenOrder + getCustomerOpenOrder;//count customer of open order
                    sumSalesOrder.Add(totalSalesOrder.Sum());

                    row["Invoiced Sales (#Customer)"] = tuple_get_CurrentMonthTotal.Item1.ToString("#,###,###,##0") + " (" + tuple_get_CurrentMonthTotal.Item4 + ")" +
                                         "<br>" + "<br>" + totalAmount.ToString("#,###,###,##0") + " (" + get_Total.Item2 + ")";
                    totalInvoicedSales.Add(tuple_get_CurrentMonthTotal.Item1);
                    totalInvoiceSalesYTD.Add(totalAmount);
                    //invoiceSales = invoiceSales + tuple_get_CurrentMonthTotal.Item4;//count customer of invoice sales

                    row["Budget"] = monthlyBudget.Item1.ToString("#,###,###,##0") +
                                  "<br>" + "<br>" + yearlyBudget.ToString("#,###,###,##0");
                    totalBudget.Add(monthlyBudget.Item1);
                    totalBudgetYTD.Add(yearlyBudget);

                    if (tuple_get_CurrentMonthTotal.Item1 != 0 && monthlyBudget.Item1 != 0)
                    {
                        calPercentage = tuple_get_CurrentMonthTotal.Item1 / monthlyBudget.Item1 * 100;
                    }

                    if (totalAmount != 0 && yearlyBudget != 0)
                    {
                        calPercentageYTD = totalAmount / yearlyBudget * 100;
                    }

                    row["Achieve Percentage(%)"] = calPercentage.ToString("N2") + "<br>" + "<br>" + calPercentageYTD.ToString("N2");
                    dt.Rows.Add(row);
                }

                row = dt.NewRow();
                double getTotalAP = 0; double getTotalApYTD = 0;

                row["Sales ID"] = "Total";
                row["Date Range"] = firstDayOfMonth + " - " + currentDate + "<br>" + "<br>" +
                                    firstDayOfYear + " - " + currentDate;

                row["Open Order (#Customer)"] = "<br>" + "<br>" + sumSalesOrder.Sum().ToString("#,###,###,##0");

                double getInvoiceSales = totalInvoicedSales.Sum();
                double getTotalInvoiceSalesYTD = totalInvoiceSalesYTD.Sum();
                row["Invoiced Sales (#Customer)"] = getInvoiceSales.ToString("#,###,###,##0") + "<br>" + "<br>" +
                                        getTotalInvoiceSalesYTD.ToString("#,###,###,##0");

                double getTotalBudget = totalBudget.Sum();
                double getTotalBudgetYTD = totalBudgetYTD.Sum();
                row["Budget"] = getTotalBudget.ToString("#,###,###,##0") + "<br>" + "<br>" + getTotalBudgetYTD.ToString("#,###,###,##0");

                if (getTotalBudget != 0)
                {
                    getTotalAP = getInvoiceSales / getTotalBudget * 100;
                }

                if (getTotalBudgetYTD != 0 && getTotalInvoiceSalesYTD != 0)
                {
                    getTotalApYTD = getTotalInvoiceSalesYTD / getTotalBudgetYTD * 100;
                }
                row["Achieve Percentage(%)"] = getTotalAP.ToString("N2") + "<br>" + "<br>" + getTotalApYTD.ToString("N2");

                dt.Rows.Add(row);
                gvReportPBM.DataSource = dt;
                gvReportPBM.DataBind();

                int row_count = gvReportPBM.Rows.Count;
                string[] result; string[] delim = { "<br><br>" };
                for (int i = 0; i < row_count; i++)
                {
                    string percentage = gvReportPBM.Rows[i].Cells[5].Text;
                    result = percentage.Split(delim, StringSplitOptions.None);
                    if (Convert.ToDouble(result[0]) < 50)
                    {
                        gvReportPBM.Rows[i].Cells[5].Text = "<span style='color:red'>" + result[0] + "</span><br><br>" + result[1];

                        if (Convert.ToDouble(result[1]) < 50)
                        {
                            gvReportPBM.Rows[i].Cells[5].Text = "<span style='color:red'>" + result[0] + "<br><br><span style='color:red'>" + result[1] + "</span>";
                        }
                    }//change textcolor to red when percentage is not below 50

                    else if (Convert.ToDouble(result[1]) < 50)
                    {
                        gvReportPBM.Rows[i].Cells[5].Text = result[0] + "<br><br><span style='color:red'>" + result[1] + "</span>";
                    }
                }
            }
            catch (Exception)
            {
                throw;
            }
        }

        protected string GridviewData(GridView gv)
        {
            StringBuilder strBuilder = new StringBuilder();
            StringWriter strWriter = new StringWriter(strBuilder);
            HtmlTextWriter htw = new HtmlTextWriter(strWriter);
            gridviewReport.RenderControl(htw);

            return strBuilder.ToString();
        }

        protected void EmailInfo(string receiver, string hod1, string hod2, string hod3, string hod4)
        {
            string MailSubject; string Sendmsg = "";

            MailSubject = "Current Month Sales Report for " + hdsalesman.Value.ToString();
            Sendmsg = GridviewData(gvReportPBM);
            string MailTo = receiver;//recipient
            Function_Method.SendMail("mailadmin", "Administrator", MailSubject, MailTo, hod1 + "," + hod2 + "," + hod3 + "," + hod4, Sendmsg);
            SalesReport.Flag = true;
        }

        public override void VerifyRenderingInServerForm(System.Web.UI.Control control)
        {
            /* Verifies that the control is rendered */
        }
    }
}